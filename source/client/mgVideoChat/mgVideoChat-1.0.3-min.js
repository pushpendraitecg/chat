window.RTCPeerConnection=window.mozRTCPeerConnection||window.webkitRTCPeerConnection||window.RTCPeerConnection;window.PeerConnection=(window.webkitPeerConnection00||window.webkitPeerConnection||window.PeerConnection);navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;window.URL=window.URL||window.webkitURL;window.RTCSessionDescription=window.mozRTCSessionDescription||window.webkitRTCSessionDescription||window.RTCSessionDescription;window.RTCIceCandidate=window.mozRTCIceCandidate||window.webkitRTCIceCandidate||window.RTCIceCandidate;(function(e,i,t,h){var m={wsURL:"ws://localhost:8080",dir:"{rel}",tplMain:"/tpls/main.html",tplConnections:"/tpls/connections.html",tplConnection:"/tpls/connection.html",tplChat:"/tpls/chat.html",sound:{mp3:"/sounds/ring.mp3",ogg:"/sounds/ring.ogg"},debug:true,login:null,rtc:{pcConfig:{iceServers:[{url:"stun:stun.l.google.com:19302"}]},pcConstraints:{optional:[{DtlsSrtpKeyAgreement:true}]},offerConstraints:{optional:[],mandatory:{}},mediaConstraints:{audio:true,video:true},sdpConstraints:{mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}},audio_receive_codec:"opus/48000"}};var y={};var x=function(B,A){this.version="1";this.elem=B;this.$elem=e(B);this.$connectionsPanel=null;this.options=A;this.metadata=this.$elem.data("mgVideoChat-options");this.config=e.extend({},m,this.options);y=this.config;n.init(this.config.rtc);this.fixPath();this.init();this.$elem.data("mgVideoChat-instance",this);this.chatId=null;this.videoId=null;this.videoInvitedId=null;this.connectionId=null;this.userData={}};x.prototype.fixPath=function(){if(this.config.dir!="{rel}"){return}var A=this;e("script").each(function(){var E=e(this).attr("src");var D="mgVideoChat-";if(E&&E.indexOf(D,this.length-D.length)!==-1){A.config.dir=E.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,"");var C=/mgVideoChat\-(\d*\.\d*\.\d*)\.js/gi;var B=C.exec(E);if(B&&B[1]){A.version=B[1]}else{C=/mgVideoChat\-(\d*\.\d*\.\d*)\-min\.js/gi;B=C.exec(E);if(B&&B[1]){A.version=B[1]}else{A.version=1}}}else{D="mgVideoChat";if(E&&E.indexOf(D,this.length-D.length)!==-1){A.config.dir=E.replace(/\\/g,"/").replace(/\/[^\/]*\/?$/,"");A.version=1}}})};x.prototype.init=function(){var A=this;this.loadTplByName("tplConnections",function(B){A.loadTplByName("tplMain",function(E){A.$elem.html(A.tmpl(E,{config:A.config}));A.$connectionsPanel=A.$elem.find("#connectionsPanel");A.$messagePanel=A.$elem.find("#messagePanel");A.$loginPanel=A.$elem.find("#loginPanel");A.$videoPanel=A.$elem.find("#videoPanel");A.$loginDialog=A.$elem.find("#loginDialog");A.$callPanel=A.$elem.find("#callPanel");A.$answerDialog=A.$elem.find("#answerDialog");A.$chatPanel=A.$elem.find("#chatPanel");var G={};if(!n.checkCompatibility(G)){A.debug(G);var F={websocket:"Your browser does not support websocket.",peerconnection:"Your browser does not support PeerConnections.",usermedia:"Your browser does not support user media."};var D=[];for(var C in G){D.push(F[C])}D.push('Please try <a href="http://www.google.com/chrome" target="_blank">Google Chrome</a> or <a href="http://www.mozilla.org/en-US/firefox" target="_blank">Mozilla Firefox</a>');A.message(D.join("<br>"),"danger")}else{n.connect(A.config.wsURL)}A.initDom();A.initRtc()})})};x.prototype.initDom=function(){var A=this;A.$loginPanel.find("#loginButton").click(function(){if(A.config.login){A.config.login(function(){n.login()})}else{A.$loginDialog.modal("show")}});A.$loginDialog.on("shown.bs.modal",function(){A.$loginDialog.find("#userName").focus()});var B=function(){if(A.$loginDialog.find("#userName").val()){A.setCookie("mgVideoChatSimple",A.$loginDialog.find("#userName").val(),30,i.location.host);A.$loginDialog.modal("hide");i.location.reload()}};A.$loginDialog.find("#userName").keypress(function(C){if(C.keyCode===13){B();return false}});A.$loginDialog.find("button.login").click(B);A.$videoPanel.find("#videoFullScreen").click(function(){var C=A.$videoPanel.get(0),D=C.requestFullScreen||C.webkitRequestFullScreen||C.mozRequestFullScreen;D.call(C)});A.$videoPanel.find("#videoExitFullScreen").click(function(){var C=t.cancelFullScreen||t.webkitCancelFullScreen||t.mozCancelFullScreen;C.call(t)});A.$videoPanel.find("#callHangup").click(function(){n.drop(A.videoId)});A.$answerDialog.find("#answer").click(function(){n.accept(A.$answerDialog.data("caller_id"),{audio:true,video:true});A.$answerDialog.modal("hide")});A.$answerDialog.find("#answerAudio").click(function(){n.accept(A.$answerDialog.data("caller_id"),{audio:true,video:false});A.$answerDialog.modal("hide")});A.$answerDialog.find("#cancelCall").click(function(){n.drop(A.$answerDialog.data("caller_id"));A.$answerDialog.modal("hide")})};x.prototype.setCookie=function(E,B,D,A){var C=A?("; domain="+A):"";t.cookie=E+"="+encodeURIComponent(B)+"; max-age="+(60*60*24*D)+"; path=/"+C};var p=null;x.prototype.message=function(E,C,B){if(p){i.clearTimeout(p)}var A=this;var D=A.$messagePanel.find(".alert");var F=A.$messagePanel.data("type");if(!E){A.$messagePanel.hide();return}D.removeClass("alert-"+F).addClass("alert-"+C);D.find("div.text").html(E);A.$messagePanel.data("type",C);A.$messagePanel.show();if(B){p=i.setTimeout(function(){A.$messagePanel.hide();p=null},B*1000)}};x.prototype.debug=function(A){if(this.config.debug){console.log(A)}};x.prototype.onConnected=function(){this.$loginPanel.show()};x.prototype.onDisconnected=function(){this.disableChat()};x.prototype.onLogged=function(){this.$loginPanel.hide()};x.prototype.onConnectionClose=function(A){this.$connectionsPanel.find("#connection_"+A).remove();this.disableChat(A);if(this.videoId==A){this.onVideoClose()}if(this.videoInvitedId==A){this.inviteStop()}delete n.connections[A]};x.prototype.onVideoOpen=function(A){this.videoId=A;this.$callPanel.find(".panel-title").text("Video Call with "+n.connections[A]["data"]["userData"]["name"]);this.$callPanel.show();this.renderConnections()};x.prototype.onVideoClose=function(){var A=this;this.videoId=null;A.$elem.find("#localVideo").attr("src","");A.$elem.find("#remoteVideo").attr("src","");A.$callPanel.hide();A.inviteStop();this.renderConnections()};x.prototype.inviteStart=function(A){this.videoAnswerDialog(A);this.videoInvitedId=A;this.callRing(false)};x.prototype.inviteStop=function(){this.$answerDialog.modal("hide");this.videoInvitedId=null;this.callRing(true)};x.prototype.videoAnswerDialog=function(C){var B=this;var A=n.connections[C].data.userData;B.$answerDialog.data("caller_id",C);B.$answerDialog.find(".username").text(A.name);if(A.image){B.$answerDialog.find(".desc").html('<img src="'+A.image+'" alt="'+A.name+'"/>')}B.$answerDialog.modal("show")};x.prototype.callRing=function(A){var B=this.$elem.find("#ringSound").get(0);if(A){B.pause()}else{B.play()}};x.prototype.initRtc=function(){var A=this;n.on("connected",function(){n.login();A.onConnected()});n.on("connectionId",function(B){A.connectionId=B.connectionId;A.userData=B.data.data.userData});n.on("logged",function(){A.onLogged()});n.on("chat_message",function(B){A.renderChatMessage(B.connectionId,B.connectionId,B.message);if(A.chatId!=B.connectionId){if(!n.connections[B.connectionId]["data"].unread){n.connections[B.connectionId]["data"].unread=0}n.connections[B.connectionId]["data"].unread++;A.renderConnection(B.connectionId)}});n.on("call_busy",function(B){A.message("Callee is busy at the moment :(","danger",3)});n.on("connections",function(B){A.renderConnections()});n.on("connection_add",function(B){A.renderConnection(B.connectionId)});n.on("connection_remove",function(B){A.onConnectionClose(B.connectionId)});n.on("rstream_added",function(C,B){A.$elem.find("#remoteVideo").attr("src",i.URL.createObjectURL(C));A.onVideoOpen(B)});n.on("stream_added",function(C,B){A.$elem.find("#localVideo").attr("src",i.URL.createObjectURL(C));A.onVideoOpen(B)});n.on("media_request_start",function(){A.$elem.find("#requestDialog").modal("show")});n.on("media_request_end",function(){A.$elem.find("#requestDialog").modal("hide")});n.on("status",function(C,B){switch(B){case"call_inviting":A.callRing(false);break;case"call_invited":if(A.videoId){n.busy(C);n.drop(C)}else{A.inviteStart(C)}break;case"call_accepting":case"call_accepted":A.$videoPanel.data("call_id",C);A.inviteStop();break;case"idle":A.callRing(true);if(A.videoId==C){A.onVideoClose()}if(A.videoInvitedId==C){A.inviteStop()}break;default:break}A.renderConnection(C)});n.on("socket_error",function(B){A.message("Error connecting to media server.","danger");A.onDisconnected()});n.on("socket_closed",function(B){A.message("Websocket closed, please try reloading page later.","danger");A.onDisconnected()});n.on("stream_error",function(B){A.message("Error getting local media stram.","danger")});n.on("pc_error",function(B){A.message("Error creating peer connection.","danger")})};x.prototype.renderConnections=function(){var A=this;A.debug("connections");A.debug(n.connections);this.loadTplByName("tplConnections",function(B){var C=A.tmpl(B,{rows:n.connections});A.$connectionsPanel.html(C);for(var D in n.connections){A.renderConnection(D)}if(!n.connections.length){A.$connectionsPanel.find("#lonely").show()}})};x.prototype.renderConnection=function(B){var A=this;this.getConnectionElement(B,function(D){var C=A.$connectionsPanel.find("#connection_"+B);if(C.length){C.replaceWith(D)}else{A.$connectionsPanel.find("#connections").append(D)}A.$connectionsPanel.find("#lonely").hide()})};x.prototype.getConnectionElement=function(B,C){var A=this;if(!n.connections[B]){return false}this.loadTplByName("tplConnection",function(G){var E=n.connections[B],D=E.status?E.status:"idle";var H={id:B,status:D,userData:E.data["userData"],videoId:A.videoId,chatId:A.chatId,unread:(E.data.unread)?E.data.unread:0};var F=e(A.tmpl(G,H));F.click(function(){A.$connectionsPanel.find(".connectionItem").removeClass("active");e(this).addClass("active");A.setChat(e(this).data("connection_id"))});F.find(".call.cmdBtn").click(function(){n.invite(e(this).data("id"),{audio:true,video:true})});F.find(".callAudio.cmdBtn").click(function(){n.invite(e(this).data("id"),{audio:true,video:false})});F.find(".answer.cmdBtn").click(function(){A.debug("Clicked to answer the connectionId: "+e(this).data("id"));n.accept(e(this).data("id"),{audio:true,video:true})});F.find(".drop.cmdBtn").click(function(){A.debug("Clicked to drop the connectionId: "+e(this).data("id"));n.drop(e(this).data("id"))});if(A.chatId==B){F.addClass("active")}C(F)})};x.prototype.getChatDiv=function(C){var B=this;var A=this.$chatPanel.find("#chat_"+C);if(!A.length){A=e('<div id="chat_'+C+'" class="chat"><ul data-id="'+C+'" class="messages media-list"></ul><textarea data-id="'+C+'" class="form-control" rows="3" placeholder="Send a message ..."></textarea></div>');A.appendTo(this.$chatPanel.find("#chats"));A.find("textarea").keypress(function(E){var D=e(this);if(E.keyCode===13&&E.shiftKey){D.val(D.val()+"\n");return false}if(E.keyCode===13){n.chatMessage(C,D.val());B.renderChatMessage(C,B.connectionId,D.val());D.val("");return false}})}return A};x.prototype.disableChat=function(A){if(!A){this.$chatPanel.find(".form-control").attr("disabled","disabled")}else{this.$chatPanel.find("#chat_"+A+" .form-control").attr("disabled","disabled")}};x.prototype.setChat=function(A){this.chatId=A;this.$chatPanel.find(".chat").hide();this.getChatDiv(A).show();this.$chatPanel.find(".panel-title").text("Chat with "+n.connections[A]["data"]["userData"]["name"]);this.$chatPanel.show();if(n.connections[A]["data"].unread){n.connections[A]["data"].unread=0;this.renderConnection(A)}};x.prototype.parseChatMessageText=function(D){function C(G,F){var E=(F||typeof F==="undefined")?"<br />":"<br>";return(G+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+E+"$2")}function A(F){var E=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;return F.replace(E,"<a target=\"_blank\" href='$1'>$1</a>")}function B(I){var F,H,G,E;H=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;F=I.replace(H,'<a href="$1" target="_blank">$1</a>');G=/(^|[^\/])(www\.[\S]+(\b|$))/gim;F=F.replace(G,'$1<a href="http://$2" target="_blank">$2</a>');E=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;F=F.replace(E,'<a href="mailto:$1">$1</a>');return F}return C(B(D),false)};x.prototype.renderChatMessage=function(D,C,E){var B=this;var A=this.getChatDiv(D);this.loadTplByName("tplChat",function(F){var I={message:B.parseChatMessageText(E),me:false};if(C===B.connectionId){I.me=true;I.userData=B.userData}else{I.userData=n.connections[C]["data"]["userData"]}var H=B.tmpl(F,I);var G=A.find(".messages");G.append(H).scrollTop(G.get(0).scrollHeight)})};var r={};x.prototype.tmpl=function k(C,B){var A=!/\W/.test(C)?r[C]=r[C]||k(t.getElementById(C).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+C.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return B?A(B):A};var q={};x.prototype.loadTplByName=function(A,B){this.loadTpl(this.config.dir+this.config[A]+"?v="+this.version,B)};x.prototype.loadTpl=function(A,B){if(q[A]==null){e.get(A,function(C){q[A]=C;if(B){B(C)}},"html")}else{if(B){B(q[A])}}return q[A]};e.fn.mgVideoChat=function(A,C){if(A==="methodName"){var B=e(this).data("mgVideoChat-instance");if(B){return B.methodName(C)}}else{this.each(function(){return new x(this,A)})}};var n={firefox:false};n.init=function(A){n.config=A;if(navigator.mozGetUserMedia){n.firefox=true}};n._socket=null;n._events={};n.on=function(A,B){n._events[A]=n._events[A]||[];n._events[A].push(B)};n.fire=function(B,D){n.debug("fired ["+B+"]");var F=n._events[B];var C=Array.prototype.slice.call(arguments,1);if(!F){return}for(var E=0,A=F.length;E<A;E++){F[E].apply(null,C)}};n.connections={};n.id=null;n.compatible=true;n.debug=function(A){if(y.debug){console.log(A)}};n.checkCompatibility=function s(A){n.compatible=true;if(!i.WebSocket){A.websocket=true;n.compatible=false}if(!i.RTCPeerConnection&&!i.PeerConnection){A.peerconnection=true;n.compatible=false}if(!navigator.getUserMedia){A.usermedia=true;n.compatible=false}return n.compatible};n.connect=function(A){n._socket=new WebSocket(A);n._socket.onopen=function(){n.fire("connected")};n._socket.onmessage=function(C){var B=JSON.parse(C.data);n.debug("RECEIVED MESSAGE "+B.type);n.debug(B);n.fire(B.type,B.data)};n._socket.onerror=function(B){n.debug("onerror");n.debug(B);n.fire("socket_error",B)};n._socket.onclose=function(B){n.fire("socket_closed",{})}};n.on("connections",function(A){n.connections=A});n.on("connectionId",function(A){n.id=A.connectionId;n.fire("logged",A.data)});n.on("connection_add",function(A){n.connections[A.connectionId]=A.data});n.on("connection_remove",function(A){delete n.connections[A.connectionId]});n.on("call_invite",function(A){n.setStatus(A.connectionId,"call_invited")});n.on("call_accept",function(A){if(n.refuseIdleState(A.connectionId)){return false}n.setStatus(A.connectionId,"call_accepted");n.sdpOffer(A.connectionId)});n.on("call_drop",function(A){n.stop(A.connectionId)});n.on("sdp_offer",function(A){if(n.refuseIdleState(A.connectionId)){return false}n.connections[A.connectionId].offerSdp=A.sdp;n.setStatus(A.connectionId,"sdp_offered");n.sdpAnswer(A.connectionId)});n.on("sdp_answer",function(B){if(n.refuseIdleState(B.connectionId)){return false}var A=n.connections[B.connectionId].pc;A.setRemoteDescription(new RTCSessionDescription(B.sdp));n.setStatus(B.connectionId,"sdp_answered")});n.on("ice_candidate",function(B){if(n.refuseIdleState(B.connectionId)){return false}var A=n.connections[B.connectionId].pc;A.addIceCandidate(new RTCIceCandidate({sdpMLineIndex:B.label,candidate:B.candidate}))});n.setStatus=function j(B,A){n.debug("status ["+A+"] for connectionId: "+B);n.connections[B].status=A;n.fire("status",B,A)};n.refuseIdleState=function(A){return n.connections[A].status=="idle"};n.send=function d(A){n.debug("SENDING MSG "+A.type);n.debug(A);n._socket.send(JSON.stringify(A))};n.chatMessage=function g(A,B){n.send({type:"chat_message",data:{connectionId:A,message:B}})};n.login=function l(A){n.send({type:"login",data:A})};n.invite=function w(B,A){n.debug("creating local media stream");n.setStatus(B,"call_inviting");n.createStream(B,A,function C(D){n.debug("inviting call for id: "+B);n.send({type:"call_invite",data:{connectionId:B}})})};n.accept=function f(C,A){n.debug("creating local media stream");n.createStream(C,A,function B(D){n.debug("accepting call from id: "+C);n.send({type:"call_accept",data:{connectionId:C}});n.setStatus(C,"call_accepting")})};n.drop=function c(A){n.debug("droping call");n.send({type:"call_drop",data:{connectionId:A}});n.stop(A)};n.busy=function u(A){n.debug("sending busy signal");n.send({type:"call_busy",data:{connectionId:A}})};n.stop=function v(A){if(n.connections[A].pc){n.connections[A].pc.close();n.connections[A].pc=null}if(n.connections[A].stream){n.connections[A].stream.stop()}n.setStatus(A,"idle")};n.mergeConstraints=function(C,B){var A=C;for(var D in B.mandatory){A.mandatory[D]=B.mandatory[D]}A.optional.concat(B.optional);return A};n.onCreateSessionDescriptionError=function(A){n.debug("Failed to create session description: "+A.toString())};n.extractSdp=function(B,C){var A=B.match(C);return(A&&A.length==2)?A[1]:null};n.setDefaultCodec=function(B,E){var D=B.split(" ");var F=new Array();var A=0;for(var C=0;C<D.length;C++){if(A===3){F[A++]=E}if(D[C]!==E){F[A++]=D[C]}}return F.join(" ")};n.removeCN=function(B,F){var D=B[F].split(" ");for(var A=B.length-1;A>=0;A--){var E=n.extractSdp(B[A],/a=rtpmap:(\d+) CN\/\d+/i);if(E){var C=D.indexOf(E);if(C!==-1){D.splice(C,1)}B.splice(A,1)}}B[F]=D.join(" ");return B};n.preferAudioCodec=function(B){if(!n.config.audio_receive_codec){return B}var G=n.config.audio_receive_codec;var D=G.split("/");if(D.length!=2){return B}var A=D[0];var E=D[1];var I=B.split("\r\n");for(var C=0;C<I.length;C++){if(I[C].search("m=audio")!==-1){var J=C;break}}if(J===null){return B}for(var C=0;C<I.length;C++){if(I[C].search(A+"/"+E)!==-1){var F=new RegExp(":(\\d+) "+A+"\\/"+E,"i");var H=n.extractSdp(I[C],F);if(H){I[J]=n.setDefaultCodec(I[J],H)}break}}I=n.removeCN(I,J);B=I.join("\r\n");return B};n.sdpOffer=function a(B){var A=n.createPeerConnection(B);var C=n.mergeConstraints(n.config.offerConstraints,n.config.sdpConstraints);A.createOffer(function(D){D.sdp=n.preferAudioCodec(D.sdp);A.setLocalDescription(D);n.send({type:"sdp_offer",data:{connectionId:B,sdp:D}})},n.onCreateSessionDescriptionError,C);n.setStatus(B,"sdp_offering")};n.sdpAnswer=function b(B){n.debug("Answering call connectionId: "+B);var A=n.createPeerConnection(B);A.setRemoteDescription(new RTCSessionDescription(n.connections[B].offerSdp));A.createAnswer(function(C){C.sdp=n.preferAudioCodec(C.sdp);A.setLocalDescription(C);n.send({type:"sdp_answer",data:{connectionId:B,sdp:C}})},n.onCreateSessionDescriptionError,n.config.sdpConstraints);n.setStatus(B,"sdp_answering")};n.createStream=function z(B,A,E,F){E=E||function(G){};F=F||function(){alert("Could not connect stream.")};try{n.fire("media_request_start");var D=e.extend({},n.config.mediaConstraints,A);navigator.getUserMedia(D,function(G){n.fire("media_request_end");if(n.refuseIdleState(B)){G.stop();return false}n.connections[B].stream=G;E(G);n.fire("stream_added",G,B)},function(G){n.fire("media_request_end");F(G);n.fire("stream_error",G)})}catch(C){n.fire("media_request_end");n.fire("stream_error",C)}};n.createPeerConnection=function o(B){n.debug("createPeerConnection for id: "+B);try{n.connections[B].pc=new i.RTCPeerConnection(n.config.pcConfig,n.config.pcConstraints);n.connections[B].pc.onicecandidate=function(D){if(D.candidate){n.send({type:"ice_candidate",data:{candidate:D.candidate.candidate,connectionId:B,label:D.candidate.sdpMLineIndex}})}}}catch(C){n.debug("Failed to create RTCPeerConnection, exception: "+C.message);n.fire("pc_error",C);alert("Cannot create PeerConnection object; Is the 'PeerConnection' flag enabled in about:flags?");return null}var A=n.connections[B].pc;A.onconnecting=function(){n.debug("Session connecting.")};A.onopen=function(){n.debug("Session opened.");n.fire("pc_opened",B)};A.onaddstream=function(D){n.debug("Remote stream added.");n.fire("rstream_added",D.stream,B);n.setStatus(B,"call")};A.onremovestream=function(){n.debug("Remote stream removed.")};A.addStream(n.connections[B].stream);return A}})(jQuery,window,document);